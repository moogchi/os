// Copium OS Framebuffer Driver
// Graphics mode rendering for visual debugging

#include "../../include/framebuffer.h"
#include "../../include/copium.h"

static framebuffer_t fb = {0};

void framebuffer_init(uint64_t addr, uint32_t width, uint32_t height,
                      uint32_t pitch, uint8_t bpp) {
  fb.address = (uint32_t *)(uint32_t)addr;
  fb.width = width;
  fb.height = height;
  fb.pitch = pitch;
  fb.bpp = bpp;
  fb.initialized = true;
}

framebuffer_t *framebuffer_get(void) { return &fb; }

void framebuffer_clear(uint32_t color) {
  if (!fb.initialized)
    return;

  for (uint32_t y = 0; y < fb.height; y++) {
    for (uint32_t x = 0; x < fb.width; x++) {
      framebuffer_putpixel(x, y, color);
    }
  }
}

void framebuffer_putpixel(uint32_t x, uint32_t y, uint32_t color) {
  if (!fb.initialized || x >= fb.width || y >= fb.height)
    return;

  uint32_t offset = y * (fb.pitch / 4) + x;
  fb.address[offset] = color;
}

void framebuffer_fill_rect(uint32_t x, uint32_t y, uint32_t width,
                           uint32_t height, uint32_t color) {
  if (!fb.initialized)
    return;

  for (uint32_t dy = 0; dy < height; dy++) {
    for (uint32_t dx = 0; dx < width; dx++) {
      framebuffer_putpixel(x + dx, y + dy, color);
    }
  }
}

// Simple 8x8 font for basic text rendering
static const uint8_t font_8x8[128][8] = {
    [' '] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['!'] = {0x18, 0x3C, 0x3C, 0x18, 0x18, 0x00, 0x18, 0x00},
    ['.'] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00},
    [','] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30},
    ['0'] = {0x3C, 0x66, 0x6E, 0x76, 0x66, 0x66, 0x3C, 0x00},
    ['1'] = {0x18, 0x38, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00},
    ['2'] = {0x3C, 0x66, 0x06, 0x0C, 0x18, 0x30, 0x7E, 0x00},
    ['3'] = {0x3C, 0x66, 0x06, 0x1C, 0x06, 0x66, 0x3C, 0x00},
    ['A'] = {0x18, 0x3C, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x00},
    ['B'] = {0x7C, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x7C, 0x00},
    ['C'] = {0x3C, 0x66, 0x60, 0x60, 0x60, 0x66, 0x3C, 0x00},
    ['D'] = {0x78, 0x6C, 0x66, 0x66, 0x66, 0x6C, 0x78, 0x00},
    ['E'] = {0x7E, 0x60, 0x60, 0x7C, 0x60, 0x60, 0x7E, 0x00},
    ['F'] = {0x7E, 0x60, 0x60, 0x7C, 0x60, 0x60, 0x60, 0x00},
    ['G'] = {0x3C, 0x66, 0x60, 0x6E, 0x66, 0x66, 0x3C, 0x00},
    ['H'] = {0x66, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x00},
    ['I'] = {0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00},
    ['K'] = {0x66, 0x6C, 0x78, 0x70, 0x78, 0x6C, 0x66, 0x00},
    ['L'] = {0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7E, 0x00},
    ['M'] = {0x63, 0x77, 0x7F, 0x6B, 0x63, 0x63, 0x63, 0x00},
    ['O'] = {0x3C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00},
    ['P'] = {0x7C, 0x66, 0x66, 0x7C, 0x60, 0x60, 0x60, 0x00},
    ['S'] = {0x3C, 0x66, 0x60, 0x3C, 0x06, 0x66, 0x3C, 0x00},
    ['T'] = {0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00},
    ['U'] = {0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00},
    ['a'] = {0x00, 0x00, 0x3C, 0x06, 0x3E, 0x66, 0x3E, 0x00},
    ['b'] = {0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x7C, 0x00},
    ['c'] = {0x00, 0x00, 0x3C, 0x66, 0x60, 0x66, 0x3C, 0x00},
    ['d'] = {0x06, 0x06, 0x3E, 0x66, 0x66, 0x66, 0x3E, 0x00},
    ['e'] = {0x00, 0x00, 0x3C, 0x66, 0x7E, 0x60, 0x3C, 0x00},
    ['f'] = {0x1C, 0x36, 0x30, 0x7C, 0x30, 0x30, 0x30, 0x00},
    ['h'] = {0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x00},
    ['i'] = {0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x3C, 0x00},
    ['k'] = {0x60, 0x60, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0x00},
    ['l'] = {0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00},
    ['m'] = {0x00, 0x00, 0x66, 0x7F, 0x7F, 0x6B, 0x63, 0x00},
    ['n'] = {0x00, 0x00, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x00},
    ['o'] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x3C, 0x00},
    ['p'] = {0x00, 0x00, 0x7C, 0x66, 0x66, 0x7C, 0x60, 0x60},
    ['r'] = {0x00, 0x00, 0x7C, 0x66, 0x60, 0x60, 0x60, 0x00},
    ['s'] = {0x00, 0x00, 0x3E, 0x60, 0x3C, 0x06, 0x7C, 0x00},
    ['t'] = {0x30, 0x30, 0x7C, 0x30, 0x30, 0x36, 0x1C, 0x00},
    ['u'] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x00},
    ['v'] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00},
    ['y'] = {0x00, 0x00, 0x66, 0x66, 0x3E, 0x06, 0x3C, 0x00},
    ['z'] = {0x00, 0x00, 0x7E, 0x0C, 0x18, 0x30, 0x7E, 0x00},
};

void framebuffer_draw_char(uint32_t x, uint32_t y, char c, uint32_t fg,
                           uint32_t bg) {
  if (!fb.initialized)
    return;

  const uint8_t *glyph = font_8x8[(uint8_t)c];

  for (int row = 0; row < 8; row++) {
    for (int col = 0; col < 8; col++) {
      uint32_t px = x + col;
      uint32_t py = y + row;

      if (glyph[row] & (0x80 >> col)) {
        framebuffer_putpixel(px, py, fg);
      } else {
        framebuffer_putpixel(px, py, bg);
      }
    }
  }
}

void framebuffer_print(const char *str, uint32_t x, uint32_t y,
                       uint32_t color) {
  if (!fb.initialized)
    return;

  uint32_t cx = x;
  uint32_t cy = y;

  while (*str) {
    if (*str == '\n') {
      cx = x;
      cy += 8;
    } else {
      framebuffer_draw_char(cx, cy, *str, color, COLOR_BLACK);
      cx += 8;
    }
    str++;
  }
}
